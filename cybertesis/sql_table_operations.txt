-- Vista de tesis_full, es un join de muchas tablas que muestra casi todas las columnas de todas las tablas relacionadas a tesis
-- En esta vista se realiza la busqueda en todas las columnas cuando un usuario ingresa una palabra en el buscador
CREATE OR REPLACE FUNCTION refresh_full() returns void
AS
$BODY$
declare
begin
    create or replace view tesis_full
as
select t.id as id, t.added_date, t.title, t.description, t.year, t.career_id, tc.name as career_name, tf.name as faculty_name, tf.place,
ti.id as institution_id, ti.name as institution_name, array_to_string(array_agg(distinct aa.name),',') AS authors, array_to_string(array_agg(distinct at.name),',') AS tutors
from tesis_tesis t
join tesis_career tc on tc.id = t.career_id
join tesis_faculty tf on tf.id = tc.faculty_id
join tesis_institution ti on ti.id = tf.institution_id
join tesis_tesis_author tta on tta.tesis_id = t.id
join tesis_person aa on tta.person_id = aa.id
join tesis_tesis_tutor ttt on ttt.tesis_id = t.id
join tesis_person at on ttt.person_id = at.id
group by t.id, t.added_date, t.title, t.description, t.year, t.career_id, tc.name, tf.name, tf.place, ti.id, ti.name
order by t.year DESC, t.added_date DESC;
end;
$BODY$
  LANGUAGE plpgsql VOLATILE;

--Para actualizar la vista
select refresh_full();

-- Departamentos
-- Del 1 al 17 son departamentos. Usamos el ID 18 para la capital
CREATE TABLE tesis_py_departments(
  department_id SERIAL PRIMARY KEY,
  department_name VARCHAR(100) NOT NULL,
  department_capital VARCHAR(100) NOT NULL,
  lat FLOAT,
  lon FLOAT
);

-- ************ Datos de pruebas para ranking de categorías ************  --
-- Ranking
INSERT INTO tesis_tesis_ranking (date_vote, vote_by, tesis_id) VALUES (now(), NULL, 1);
INSERT INTO tesis_tesis_ranking (date_vote, vote_by, tesis_id) VALUES (now(), NULL, 1);
INSERT INTO tesis_tesis_ranking (date_vote, vote_by, tesis_id) VALUES (now(), NULL, 1);
INSERT INTO tesis_tesis_ranking (date_vote, vote_by, tesis_id) VALUES (now(), NULL, 2);
INSERT INTO tesis_tesis_ranking (date_vote, vote_by, tesis_id) VALUES (now(), NULL, 2);
INSERT INTO tesis_tesis_ranking (date_vote, vote_by, tesis_id) VALUES (now(), NULL, 4);
INSERT INTO tesis_tesis_ranking (date_vote, vote_by, tesis_id) VALUES (now(), NULL, 8);
INSERT INTO tesis_tesis_ranking (date_vote, vote_by, tesis_id) VALUES (now(), NULL, 4);

-- Categorías
INSERT INTO tesis_category (category_name, category_fa_icon) VALUES ('Ingeniería y Tecnología', '<i class=\"fa fa-microchip\"></i>');
INSERT INTO tesis_category (category_name, category_fa_icon) VALUES ('Contabilidad Empresarial', '<i class=\"fa fa-calculator\"></i>');
INSERT INTO tesis_category (category_name, category_fa_icon) VALUES ('Educación', <i class="material-icons">library_books</i>);
INSERT INTO tesis_category (category_name, category_fa_icon) VALUES ('Arte y Bellas Artes', '<i class=\"material-icons\">bubble_chart</i>');
INSERT INTO tesis_category (category_name, category_fa_icon) VALUES ('Publicidad y Marketing', '<i class=\"fa fa-bullhorn\"></i>');
INSERT INTO tesis_category (category_name, category_fa_icon) VALUES ('Psicología','<i class=\"fa fa-slideshare\"></i>');
INSERT INTO tesis_category (category_name, category_fa_icon) VALUES ('Salud y Medicina', '<i class=\"fa fa-stethoscope\"></i>');

-- Sub.Categorias
INSERT INTO tesis_sub_category (sub_category_name) VALUES ('Ingeniería Electrónica');
INSERT INTO tesis_sub_category (sub_category_name) VALUES ('Ingeniería Informática');
INSERT INTO tesis_sub_category (sub_category_name) VALUES ('Ingeniería Eléctrica');
INSERT INTO tesis_sub_category (sub_category_name) VALUES ('Fisioterapia');
INSERT INTO tesis_sub_category (sub_category_name) VALUES ('Periodismo');
INSERT INTO tesis_sub_category (sub_category_name) VALUES ('Administración de Empresas');

-- sub-category to category
INSERT INTO tesis_sub_category_categories (subcategory_id, category_id) VALUES (1,1);
INSERT INTO tesis_sub_category_categories (subcategory_id, category_id) VALUES (2,1);
INSERT INTO tesis_sub_category_categories (subcategory_id, category_id) VALUES (3,1);
INSERT INTO tesis_sub_category_categories (subcategory_id, category_id) VALUES (4,7);
INSERT INTO tesis_sub_category_categories (subcategory_id, category_id) VALUES (5,5);
INSERT INTO tesis_sub_category_categories (subcategory_id, category_id) VALUES (6,2);
INSERT INTO tesis_sub_category_categories (subcategory_id, category_id) VALUES (5,6);

-- Tesis a sub-categorias
INSERT INTO tesis_tesis_sub_category (tesis_id, subcategory_id) VALUES (1, 1);
INSERT INTO tesis_tesis_sub_category (tesis_id, subcategory_id) VALUES (1, 2);
INSERT INTO tesis_tesis_sub_category (tesis_id, subcategory_id) VALUES (2, 2);
INSERT INTO tesis_tesis_sub_category (tesis_id, subcategory_id) VALUES (3, 4);
INSERT INTO tesis_tesis_sub_category (tesis_id, subcategory_id) VALUES (8, 3);
-- ************ FIN ************  --